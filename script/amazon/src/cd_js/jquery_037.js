!function(e){"use strict";var t={registry:{},trigger:function(t,i){this.registry[t]&&e.each(this.registry[t],function(e,t){t(i)})},on:function(e,t){this.registry[e]||(this.registry[e]=[]),this.registry[e].push(t)}},i=function(t){var i={},o=e.Deferred().resolve(),n=function(){return"resolved"!==o.state()&&"rejected"!==o.state()?o.promise():(o=e.Deferred(),i.session?o.resolve(i.session):t.registerApiConsumer(function(e){e.fatalError?o.reject(e.fatalError):(i.session=e.core.session.Session.getInstance(),o.resolve(i.session))},["core.session"]),o.promise())},s=function(){var t=Array.prototype.slice.call(arguments),i=e.Deferred();return t.push({onSuccess:i.resolve,onFailure:i.reject}),n().then(function(e){e[t.shift()].apply(e,t)},i.reject),i.promise()};return i.hasActiveSession=function(){return s("isSessionActive")},i.stopSession=function(e){return document.cookie=e+"=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;",window.localStorage&&window.localStorage.removeItem("sessionState"),s("terminateSession")},i.startSession=function(e){return s("startSession",e)},i.addListener=function(e,t){n().then(function(i){i["addSession"+e+"Listener"]&&i["addSession"+e+"Listener"](t)})},i},o=function(t,i){var o=this;o.element=t,e(o.element).wrap("<div class='public-scope'></div>"),o.options={api:i.api,eventbus:i.eventbus},o.hide(),o.element.delegate("a","click",function(){o.options.eventbus.trigger("change_view",{action:"show",view:"quit"})})};o.prototype.show=function(){e("body").addClass("coBrowsingTopFrame"),this.element.removeClass("hide")},o.prototype.hide=function(){e("body").removeClass("coBrowsingTopFrame"),this.element.addClass("hide")};var n=function(t,i){var o=this;o.element=t,o.options={api:i.api,eventbus:i.eventbus,overlaySettings:e.extend({onClose:o.onClose.bind(o)},i.overlaySettings)},o.token=o.element.find(".js_cobtokeninput"),o.error=o.element.find(".js_coberror"),o.video=o.element.find("#videoplayer"),o.element.delegate(".js_cobstartsupport","click",function(){o.start(o.token.val())}).delegate(".toggleLink","click",function(){e(window).trigger("resize"),e.mask&&e.mask.fit()}).delegate(".js_togglevideo","click",function(){var t=window.jwplayer(o.video.attr("id"));e(this).next().data("isOpen")?o.video.data("init")||(o.video.videoplayer({mp4URL:o.video.data("videourl"),autostart:!1}).data("init",!0),t.play()):"PLAYING"==t.getState()&&t.pause()}),o.token.keydown(function(e){13==e.keyCode&&o.element.find(".js_cobstartsupport").click()}),o.element.overlay(o.options.overlaySettings)};n.prototype.onClose=function(){window.jwplayer(this.video.attr("id")).stop()},n.prototype.show=function(){this.error.hide(),this.token.val(""),this.video.data("init")&&window.jwplayer(this.video.attr("id")).stop(),this.element.find(".toggleLink").each(function(){var t=e(this);t.next().data("isOpen")&&t.click()}),this.element.overlay().load().getOverlay().trigger("loaded.cob")},n.prototype.hide=function(){this.element.overlay().close().getOverlay().trigger("closed.cob")},n.prototype.start=function(e){var t=this;t.options.api.startSession(e).then(function(){t.options.eventbus.trigger("change_view",{action:"show",view:"header"}),t.options.eventbus.trigger("change_view",{action:"hide",view:"start"}),t.options.eventbus.trigger("track_SesionStart",{})},function(e){t.error.find("p").text(e.message),t.error.show()})};var s=function(e,t){var i=this;i.element=e,i.options={api:t.api,eventbus:t.eventbus,overlaySettings:t.overlaySettings},i.element.overlay(i.options.overlaySettings)};s.prototype.show=function(){this.element.overlay().load().getOverlay().trigger("loaded.cob")},s.prototype.hide=function(){this.element.overlay().close().getOverlay().trigger("closed.cob")};var r=function(e,t){var i=this;i.element=e,i.options={api:t.api,eventbus:t.eventbus,overlaySettings:t.overlaySettings,unbluCookieName:t.unbluCookieName},i.element.delegate(".js_cobstop","click",function(e){e.preventDefault(),i.options.eventbus.trigger("hide_stop"),i.options.api.stopSession(i.options.unbluCookieName).always(function(){i.options.eventbus.trigger("change_view",{action:"show",view:"finish"}),i.options.eventbus.trigger("change_view",{action:"hide",view:"header"}),i.options.eventbus.trigger("track_SesionEnd",{})})}),i.element.overlay(i.options.overlaySettings)};r.prototype.show=function(){this.element.overlay().load().getOverlay().trigger("loaded.cob")},r.prototype.hide=function(){this.element.overlay().close().getOverlay().trigger("closed.cob")};var a=function(e,t){var i=this;i.element=e,i.options={api:t.api,eventbus:t.eventbus,overlaySettings:t.overlaySettings},i.element.overlay(i.options.overlaySettings)};a.prototype.show=function(){this.element.overlay().load().getOverlay().trigger("loaded.cob")},a.prototype.hide=function(){this.element.overlay().close().getOverlay().trigger("closed.cob")};var c={cobrowsingHeaderView:o,cobrowsingStartView:n,cobrowsingAbortView:a,cobrowsingQuitView:r,cobrowsingFinishView:s};e.widget("ccf.cobrowsing",{options:{cookieName:"x-unblu-recorder-session",cookieValue:"",unbluScript:"/unblu/static/js/xmd"+parseInt((new Date).getTime()/6e4)+"/xpi0/com.unblu.client.snippet",uiTemplateUrl:"/cms/snippets/unblu.html",autoStartRegex:/#coBrowsingOverlay/,wasRedirectedRegex:/[\?&]redirected/,ecrmIds:{sessionStart:"cori7768",sessionEnd:"cori7769"},overlay:{oneInstance:!0,mask:{color:"#000",opacity:.7},onLoad:function(){e.mask.isLoaded()||(e.mask.load(),this.getOverlay().css("z-index","9999"))},onBeforeLoad:function(){this.getOverlay().css("z-index","9999")}},views:[{name:"header",selector:".js_cobheader",plugin:"cobrowsingHeaderView"},{name:"start",selector:".js_cobstart",plugin:"cobrowsingStartView"},{name:"abort",selector:".js_cobabort",plugin:"cobrowsingAbortView"},{name:"quit",selector:".js_cobquit",plugin:"cobrowsingQuitView"},{name:"finish",selector:".js_cobquitfinish",plugin:"cobrowsingFinishView"}],COBROWSING_VIEWS:c},$uiTemplate:void 0,uiTemplateLoading:void 0,eventbus:t,api:void 0,ui:{initiateDeferred:void 0,show:function(e){this[e]&&this[e].show()},hide:function(e){this[e]&&this[e].hide()}},isInIframe:function(){return window.location!==window.parent.location?!0:!1},isBrowserSupported:function(){var e=window.bowser._detect("undefined"!=typeof navigator?navigator.userAgent:"");return!e.mobile&&!!(e.msie&&e.version>=8||e.chrome&&e.version>=10||e.firefox&&e.version>=10||e.safari&&e.version>=5)},hasSessionCookie:function(){var e="(?:^| )"+this.options.cookieName+"=(.*?)(?:;|$)",t=document.cookie.match(new RegExp(e));return null==t?!1:void 0==this.options.cookieValue||""==this.options.cookieValue?!0:t[1].trim()==this.options.cookieValue?!0:!1},initiateUnbluCobrowsingSettings:function(t){t=e.extend({"x-unblu-tmp-dom-ready":!0,"x-unblu-tmp-window-alive":!0,"x-unblu-tmp-window-name":window["x-unblu-tmp-window-name"]||window.name},t),e.each(t,function(e,t){window[e]=t})},loadScripts:function(){var t=e.Deferred();return window.unblu?t.resolve():e.ajax({url:this.options.unbluScript,dataType:"script",cache:!0,timeout:5e3}).done(function(){window.unblu?t.resolve():t.reject()}).fail(function(){t.reject()}),t.promise()},getUiTemplate:function(t){var i=e.Deferred(),o=this;return o.$uiTemplate?i.resolve(o.$uiTemplate.find(t)):(o.uiTemplateLoading=o.uiTemplateLoading||e.get(o.options.uiTemplateUrl),o.uiTemplateLoading.done(function(n){o.$uiTemplate=e(n),i.resolve(o.$uiTemplate.find(t))})),i.promise()},isHttps:function(){return"https:"===document.location.protocol},urlCleanup:function(){if(window.history&&"pushState"in window.history){var e=document.location.href;history.replaceState({},"",e.replace(this.options.autoStartRegex,"").replace(this.options.wasRedirectedRegex,""))}},isAutoStart:function(e){return this.options.autoStartRegex.test(e)},trackCori:function(e){window.eCrm&&window.eCrm.log(e)},appendTemplate:function(t){t.appendTo("body"),e.pluginexecutor.execute(t,!1)},initUi:function(){var t=this;return t.ui.initiateDeferred=t.ui.initiateDeferred||e.when.apply(e,e.map(t.options.views,function(e){return t.getUiTemplate(e.selector).done(function(i){t.appendTemplate(i),t.ui[e.name]=new t.options.COBROWSING_VIEWS[e.plugin](i,{api:t.api,eventbus:t.eventbus,overlaySettings:t.options.overlay,unbluCookieName:t.options.cookieName})})}))},initateViewEventHandling:function(e){var t=this;e.on("change_view",function(e){void 0!==e.action&&void 0!==e.view&&t.ui[e.action](e.view)}),e.on("track_sessionEnd",function(){t.trackCori(t.options.ecrmIds.sessionEnd)}),e.on("track_sessionStart",function(){t.trackCori(t.options.ecrmIds.sessionStart)})},activateCobrowsing:function(e){var t=this;if(e)t.ui.show("header");else if(t.hasSessionCookie()){var i=document.location.host.substring(document.location.host.indexOf("."));document.cookie=t.options.cookieName+"=; path=/; domain="+i+"; expires=Thu, 01 Jan 1970 00:00:01 GMT;",window.location.reload()}else t.ui.show("start")},start:function(e){var t=this;t.isHttps()?t.api?t.api.hasActiveSession().done(function(e){t.activateCobrowsing(e)}):this.isBrowserSupported()?t.loadScripts().done(function(){t.api=i(window.unblu),t.initUi().then(function(){t.initateViewEventHandling(t.eventbus),t.api.hasActiveSession().done(function(e){t.activateCobrowsing(e)}),t.api.addListener("Aborted",function(){t.ui.show("abort"),t.ui.hide("header")}),t.api.addListener("Terminated",function(){t.ui.show("finish"),t.ui.hide("header")})})}).fail(function(){t.showOverlay("js_coboffline")}):this.showOverlay("js_cobbrowser"):(e&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),document.location.replace(document.location.href.replace(/^http/,"https").replace(/\.html/,".html#coBrowsingOverlay?redirected")))},showOverlay:function(e){var t=this;t.ui[e]?t.ui[e].overlay().load():t.getUiTemplate("."+e).done(function(i){t.ui[e]=i,t.ui[e].appendTo("body").overlay({load:!0})})},_create:function(){var t=this;t.initiateUnbluCobrowsingSettings(),!t.isInIframe()&&t.hasSessionCookie()&&t.start(),e(document).bind("start_cobrowsing",function(e){t.start(e)}),e(document).bind("eCrm_ready",function(){t.isAutoStart(document.location.href)&&(t.start(),t.urlCleanup())})}}),e.widget("ccf.loadCoBrowsing",{options:{eventName:"start_cobrowsing"},_create:function(){this.element.bind("touchend click",function(t){"touchend"===t.type&&t.preventDefault(),e(document).trigger(this.options.eventName,t)}.bind(this))}})}(jQuery,window.bowser),$.ccfregistry.pluginReady("cobrowsing"),$.ccfregistry.pluginReady("loadCoBrowsing");