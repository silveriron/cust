Abaxx.define("widgets.tree",function(){function initAll(){jQuery(".abaxx-menu-withSubMenu[data-abx-widget\x3dmenu]").each(function(index,menu){var $menu=jQuery(menu);var options=$menu.data("abxOptions");if(!$menu.data("abxMenuInitialized")){$menu.data("abxMenuInitialized",true);installHoverSubMenu($menu,options.type,options.rowSize)}});jQuery("[data-abx-widget\x3dasync-tree]").each(function(index,tree){var $tree=jQuery(tree);var options=$tree.data("abxOptions");if(!$tree.data("abxTreeInitialized")){$tree.data("abxTreeInitialized",
true);init(tree.id,options.reloadScripts)}})}var partialReload=function(treeId,nodeId,url,reloadScripts){jQuery.ajax(Abaxx.ajax.urlForSinglePart(url),{data:{targetId:nodeId},dataType:"text",success:function(data,status,request){var response=Abaxx.ajax.parseHtml(data);var newDoc=response.scriptless;var nodeSelector="[id\x3d'"+nodeId+"-node']";var newElement=jQuery(nodeSelector,newDoc);if(newElement.length===0)Abaxx.ajax.triggerPartialLoadFailedEvent({request:request,url:url,cause:"Element not found "+
nodeSelector});else{newElement=newElement.first();jQuery(nodeSelector).replaceWith(newElement);var filterByClass=function(){var cssClass=jQuery(this).attr("class")||"";return cssClass.indexOf(nodeId+"-child")!==-1};jQuery(nodeSelector).closest(".tree").find("*").filter(filterByClass).remove();jQuery(".tree *",newDoc).filter(filterByClass).insertAfter(newElement);if(reloadScripts)Abaxx.ajax.executeScripts(response.scripts);Abaxx.ajax.triggerHtmlChangedEvent({changed:jQuery(nodeSelector)});Abaxx.ajax.triggerPartialLoadEvent()}},
error:function(request,status){Abaxx.ajax.triggerPartialLoadFailedEvent({request:request,url:url,cause:status})}});return false};var _rTargetIdForNode=/^(.+)-node$/;var _rTargetIdForChunk=/^(.+)-node(?:-prev|-next)$/;var init=function(treeId,reloadScripts){var expandOrCollapseNode=function(event){var $this;var nodeId;if(!event.isDefaultPrevented()){$this=jQuery(this);nodeId=$this.parents(".tree-node").attr("id").match(_rTargetIdForNode)[1];partialReload(treeId,nodeId,$this.attr("href"),reloadScripts);
event.preventDefault()}};var navigateChunk=function(event){var $this;var nodeId;if(!event.isDefaultPrevented()){$this=jQuery(this);nodeId=$this.parents(".tree-prev, .tree-next").attr("id").match(_rTargetIdForChunk)[1];partialReload(treeId,nodeId,$this.attr("href"),reloadScripts);event.preventDefault()}};jQuery("[id\x3d'"+treeId+"']").off("click.tree-widget").on("click.tree-widget","a[data-xtree-expand]",expandOrCollapseNode).on("click.tree-widget",".tree-prev a, .tree-next a",navigateChunk)};var installHoverSubMenu=
function($menu,type,rowSize){jQuery(document).ready(function($){if(rowSize>0)$menu.find("li.tree-l1").each(function(index$$0,submenu){var $submenu=$(submenu);if($submenu.find("li.tree-l3").length>0){var width=0;var rows=$submenu.find("li.tree-l2");for(var i=0;i<rows.length;i+=rowSize){var entries=rows.slice(i,i+rowSize);var entriesWidth=0;entries.each(function(index,entry){entriesWidth+=$(entry).width()});if(entriesWidth>width)width=entriesWidth;entries.wrapAll('\x3cdiv class\x3d"abaxx-menu-row"/\x3e')}$submenu.find("div.abaxx-menu-row").width(width);
$submenu.children("ul").css("left","-"+width/4+"px")}});var options={defaultConfig:{hoverClass:"abaxx-menu-hover",animation:{opacity:"show"},speed:"fast",delay:100}};var option=options[type];if(!option)option=options.defaultConfig;var menuElement=$menu.find("\x3e div \x3e ul");if(menuElement.superfish)menuElement.superfish(option)})};var initAbxTree=function(){Abaxx.core.companionScript("data-abx-tree-toggle",function(trigger,data){var options=data;trigger.off(".abx-tree-toggle").on("click.abx-tree-toggle",
function(event){if(!event.isDefaultPrevented()){Abaxx.ajax.partialLoad("[id\x3d'"+options.node+"']",options.url,{});event.preventDefault();event.stopPropagation()}})});Abaxx.core.companionScript("data-abx-tree-select",function(trigger$$0,options$$0){var cleanSelection=function(trigger,options){var cssSelected=options.cssSelected;var cssBranchSelected=options.cssBranchSelected;var root=trigger.closest("[data-abx-tree-root]");if(cssSelected)jQuery("."+cssSelected,root).removeClass(cssSelected);if(cssBranchSelected)jQuery("."+
cssBranchSelected,root).removeClass(cssBranchSelected)};var markNodeAsSelected=function(trigger,options){cleanSelection(trigger,options);var cssSelected=options.cssSelected;var cssBranchSelected=options.cssBranchSelected;trigger.closest("[data-abx-tree-node]").addClass(cssSelected);trigger.parentsUntil("[data-abx-tree-root]").addClass(cssBranchSelected)};var selectNode=function(event){event.preventDefault();event.stopPropagation();if(options$$0.target)window.open(options$$0.url,options$$0.target);
else if(options$$0.popupMode)Abaxx.popups.openLink(options$$0.url,options$$0.popupMode);else if(options$$0.mode=="reload")jQuery(this).trigger(new Abaxx.core.OpenLinkEvent({url:options$$0.url}));else if(options$$0.mode=="partial"){cleanSelection(trigger$$0,options$$0);var reloadId;if(options$$0.reloadId)if(options$$0.reloadId=="node")reloadId=options$$0.node;else if(options$$0.reloadId=="tree"){var root=trigger$$0.closest("[data-abx-tree-root]");reloadId=root.attr("id")}else reloadId=options$$0.reloadId;
else{root=trigger$$0.closest("[data-abx-tree-root]");reloadId=root.attr("id")}Abaxx.ajax.partialLoad("[id\x3d'"+reloadId+"']",options$$0.url,{})}else if(options$$0.mode=="onlySelect"){jQuery.ajax(options$$0.url,{type:"GET",async:false});markNodeAsSelected(trigger$$0,options$$0)}else if(options$$0.mode=="noRequest"){markNodeAsSelected(trigger$$0,options$$0);trigger$$0.trigger(jQuery.Event("abx_web_tree_node_selected",options$$0))}};trigger$$0.off(".abx-tree-select").on("click.abx-tree-select",selectNode)})};
initAbxTree();Abaxx.core.onReady(initAll);return{partialReload:partialReload,installHoverSubMenu:installHoverSubMenu,init:init}});